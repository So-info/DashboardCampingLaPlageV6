<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>La Plage ‚Äì Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%230093ff'/><text x='50' y='60' font-size='54' text-anchor='middle' fill='white'>L</text></svg>">
  <style>
:root{
      --brand:#0a84ff;
      --brand-600:#0562c7;
      --text:#0b1220;
      --muted:#6b778a;
      --bg:#f7f9fc;
      --card:#ffffff;
      --danger:#ef4444;
      --success:#16a34a;
      --shadow:0 8px 28px rgba(2, 6, 23, .08);
      --radius:6px;
}
    *{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
.container{max-width:840px;margin:0 auto;padding:14px}
header{
  position:sticky;
  top:0;
  z-index:20;
  background:var(--bg);
  backdrop-filter:saturate(1.5) blur(6px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid #eaeef5
}
.role-badge{background:#eaf2ff;border-radius:999px;padding:4px 10px;font-size:12px;color:#185adb}
/* ===== Buttons (compact + premium) ===== */
.btn{
  --h:40px; --rad:12px; --padx:14px;
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  height:var(--h); padding:0 var(--padx);
  font-weight:800; font-size:15px; line-height:1;
  border-radius:var(--rad); border:1px solid transparent;
  background:#fff; color:var(--text);
  box-shadow:0 2px 8px rgba(2,6,23,.08);
  transition:transform .15s ease, filter .15s ease, box-shadow .15s ease, border-color .15s ease;
}
.btn-sm{ --h:36px; --rad:10px; --padx:12px; font-size:14px; }

.btn-primary{
  background:linear-gradient(180deg,#0a84ff,#0562c7);
  color:#fff; border-color:rgba(10,132,255,.35);
  box-shadow:0 6px 16px rgba(10,132,255,.25);
}
.btn-primary:hover{ filter:brightness(1.04); transform:translateY(-1px); }
.btn-primary:active{ transform:translateY(0); }

.btn-outline{
  background:#fff; color:var(--text);
  border-color:#e6ebf2;
}
.btn-outline:hover{ border-color:#cbd5e1; box-shadow:0 3px 10px rgba(2,6,23,.06); }

.btn-danger{
  background:linear-gradient(180deg,#f87171,#ef4444);
  color:#fff; border-color:rgba(239,68,68,.35);
  box-shadow:0 6px 16px rgba(239,68,68,.22);
}
.btn-danger:hover{ filter:brightness(1.04); }
.btn-success{
  background:linear-gradient(180deg,#22c55e,#16a34a);
  color:#fff; border-color:rgba(34,197,94,.35);
  box-shadow:0 6px 16px rgba(22,163,74,.22);
}

.btn-success{background:var(--success);color:#fff}
.hidden{display:none!important}
.center{display:grid;place-items:center;min-height:100dvh;padding:22px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.login-card{width:min(420px,100%);text-align:center;padding:22px}
.logo{display:flex;align-items:center;justify-content:center;gap:10px;margin:14px 0 8px}
.logo img{height:48px;object-fit:contain}
h1{font-size:22px;margin:0 0 8px}
p.muted{color:var(--muted);margin:0 0 18px}

/* dashboard layout */
.grid{display:grid;gap:14px}
.stack{display:flex;flex-direction:column;gap:10px}
.section-title{font-weight:900;margin:6px 0 6px}
nav.tabs{
  position:sticky;
  top:58px;
  background:var(--bg);
  padding:10px 12px 6px;
  margin:0;
  border-bottom:1px solid #eaeef5;
  z-index:15;
  overflow-x:auto;
  white-space:nowrap
}
nav.tabs .tab{
  display:inline-block;
  margin:0 8px 0 0;
  padding:10px 14px;
  border-radius:999px;
  background:#fff;
  border:1px solid #e6ebf2;
  color:#0b1220;
  font-weight:800
}
nav.tabs .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}

label{font-size:13px;color:#334155;font-weight:800;display:block;margin:10px 0 6px}
input[type="text"], textarea, select{
  width:100%;
  border:1px solid #e6ebf2;
  border-radius:14px;
  padding:14px 14px;
  font-size:16px;
  outline:none;
  background:#fff
}
input::placeholder, textarea::placeholder{color:#97a1b4}
textarea{min-height:110px;resize:vertical}
.row{display:flex;gap:10px}
.row>.col{flex:1}

.pill-switch{
  display:flex;
  border-radius:999px;
  overflow:hidden;
  border:1px solid #e6ebf2;
  background:#fff
}
.pill-switch button{flex:1;padding:12px 12px;border:0;background:transparent;font-weight:800}
.pill-switch .on{background:var(--brand);color:#fff}

/* Kanban mobile-first: colonnes en carrousel horizontal */
.kanban{display:flex;gap:12px;overflow-x:auto;padding-bottom:4px;scroll-snap-type:x proximity}
.kanban-col{min-width:calc(100% - 8px);background:#fff;border-radius:16px;padding:10px;border:1px solid #e6ebf2;scroll-snap-align:start}
@media (min-width:720px){
  .kanban-col{min-width:unset}
  .kanban{display:grid;grid-template-columns:repeat(3,1fr);overflow:visible}
}
.kanban-col h3{margin:4px 0 10px;font-size:14px}
.ticket{border:1px solid #e6ebf2;border-radius:14px;padding:14px;margin:8px 0}
.ticket .meta{font-size:12px;color:var(--muted)}
.chip{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5f9;font-size:12px;margin-right:6px}
.chip.green{background:#ecfdf5;color:#065f46}
.chip.red{background:#fef2f2;color:#991b1b}

/* tables */
table{width:100%;border-collapse:separate;border-spacing:0 10px}
th{font-size:12px;color:#475569;text-align:left;padding:4px 8px}
td{background:#fff;border:1px solid #e6ebf2;border-left-width:1px;border-right-width:1px;padding:12px 10px}
tr td:first-child{border-radius:14px 0 0 14px}
tr td:last-child{border-radius:0 14px 14px 0}

/* ===== Admin list (cards) ===== */
.list{display:grid;gap:12px}
.user-card{
  background:#fff;border:1px solid #e6ebf2;border-radius:16px;
  padding:14px; box-shadow: var(--shadow);
}
.uc-top{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
.uc-name{font-weight:900}
.uc-email{font-size:12px;color:var(--muted);margin-bottom:10px;word-break:break-all}
.uc-actions{display:flex;gap:8px;flex-wrap:wrap}
.chip.role{background:#eef2ff;color:#3730a3}

/* ===== Inventaire (cards) ===== */
.inv-card{
  background:#fff;border:1px solid #e6ebf2;border-radius:16px;
  padding:14px; box-shadow: var(--shadow);
}
.inv-top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
.inv-name{font-weight:900}
.inv-top .qty{
  min-width:42px;text-align:center;padding:4px 10px;border-radius:999px;
  background:#f1f5f9;border:1px solid #e6ebf2;font-weight:900;
}
.inv-actions{display:flex;gap:8px;flex-wrap:wrap}

/* ===== Tickets (badges & actions) ===== */
.t-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
.t-title{font-weight:900}
.t-details{margin:8px 0}
.t-chips{margin:6px 0 2px}
.ticket-actions{display:flex;gap:8px;margin-top:10px}
.chip.pr.normal{background:#eff6ff;color:#1d4ed8}
.chip.pr.high{background:#fff7ed;color:#9a3412}
.chip.pr.urgent{background:#fef2f2;color:#b91c1c}

/* full-width primary button on mobile */
.actions-right{display:flex;justify-content:flex-end}

/* ==== Filtres & Compteurs ==== */
.toolrow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.toolrow input,.toolrow select{flex:1;min-width:150px}
.col-count{font-size:12px;background:#f1f5f9;border:1px solid #e6ebf2;border-radius:999px;padding:4px 8px;min-width:28px;text-align:center}
.kanban-col h3{display:flex;align-items:center;justify-content:space-between}

/* ===== Hamburger (beau + anim√©) ===== */
/* ===== Hamburger (carr√© partout, iOS inclus) ===== */
header .left{display:flex;align-items:center;gap:10px}

.hamburger{
  position: relative;                 /* ‚úÖ contient les barres */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 44px; height: 44px; aspect-ratio: 1/1;
  padding: 0; box-sizing: border-box;
  -webkit-appearance: none; appearance: none;
  border: 1px solid #e6ebf2;
  border-radius: 8px;                 /* mets 0 si tu veux carr√© 100% */
  background: linear-gradient(180deg,#ffffff,#f8fbff);
  box-shadow: var(--shadow);
  -webkit-tap-highlight-color: transparent;
  overflow: hidden;                    /* garde les barres √† l‚Äôint√©rieur */
}

.hamburger:active{transform:translateY(1px)}

.hamburger span{
  position:absolute; left:11px; right:11px; height:3px;
  background:#0b1220; border-radius:3px;
  transition:transform .25s ease, opacity .2s ease, top .25s ease, background .2s ease;
}
.hamburger span:nth-child(1){ top:14px; }
.hamburger span:nth-child(2){ top:20px; }
.hamburger span:nth-child(3){ top:26px; }
.hamburger:hover span{ background:#0a1f44; }

/* √âtat ouvert -> croix */
.hamburger[aria-expanded="true"] span:nth-child(1){ top:20px; transform:rotate(45deg); }
.hamburger[aria-expanded="true"] span:nth-child(2){ opacity:0; transform:scaleX(0.5); }
.hamburger[aria-expanded="true"] span:nth-child(3){ top:20px; transform:rotate(-45deg); }


.drawer{position:fixed;inset:0;pointer-events:none;z-index:50}
.drawer-backdrop{position:absolute;inset:0;background:rgba(2,6,23,.35);opacity:0;transition:opacity .2s}
.drawer-panel{position:absolute;left:0;top:0;bottom:0;width:86vw;max-width:320px;background:#fff;
  border-right:1px solid #e6ebf2;box-shadow:var(--shadow);transform:translateX(-105%);transition:transform .25s}
.drawer.open{pointer-events:auto}
.drawer.open .drawer-backdrop{opacity:1}
.drawer.open .drawer-panel{transform:translateX(0)}
.drawer-top{display:flex;align-items:center;gap:12px;padding:14px;border-bottom:1px solid #eaeef5}
.drawer-top img{height:32px;object-fit:contain}
.drawer-top .email{font-size:12px;color:#64748b}
.menu{display:flex;flex-direction:column;padding:12px}
.menu .menu-item{display:flex;align-items:center;gap:10px;padding:12px 14px;border:1px solid #e6ebf2;
  background:#fff;border-radius:12px;margin-bottom:10px;font-weight:800}
.menu .menu-item.active{background:var(--brand);border-color:var(--brand);color:#fff}
.drawer-bottom{padding:12px;border-top:1px solid #eaeef5}
/* ---- Location picker ---- */
.loc-list{display:grid;gap:10px}
.loc-row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.loc-name{font-weight:800}
.loc-ctrls{display:flex;align-items:center;gap:8px}
.loc-qty{
  min-width:36px;text-align:center;padding:6px 10px;border-radius:999px;
  background:#f1f5f9;border:1px solid #e6ebf2;font-weight:900;
}
/* ==== Location grid ==== */
.loc-grid{
  display:grid; gap:12px;
  grid-template-columns:repeat(2,1fr);
}
@media (min-width:520px){ .loc-grid{ grid-template-columns:repeat(3,1fr); } }
.loc-item{
  display:flex; flex-direction:column; gap:10px;
  background:#fff; border:1px solid #e6ebf2; border-radius:16px; padding:12px;
  box-shadow:var(--shadow);
}
.loc-head{ display:flex; justify-content:space-between; align-items:center; gap:8px }
.loc-name{ font-weight:900 }
.loc-stock{ font-size:12px; background:#f1f5f9; border:1px solid #e6ebf2; border-radius:999px; padding:4px 8px }
.stepper{ display:flex; gap:8px; align-items:center; justify-content:flex-end }
.stepper .qty{
  min-width:34px; text-align:center; padding:6px 10px; border-radius:999px;
  background:#eef2ff; color:#3730a3; font-weight:900; border:1px solid #dbeafe;
}


  </style>
</head>
<body>

<!-- LOGIN -->
<section id="view-login" class="center">
  <div class="card login-card">
<div class="logo">
  <img src="logo-camping-la-plage.png" 
       alt="La Plage" 
       style="height:60px;object-fit:contain"/>
</div>
    <h1>Bienvenue sur le dashboard<br/>du camping La Plage</h1>
    <p class="muted">Acc√©dez √† votre espace via Google.</p>
    <button id="btn-google" class="btn btn-primary" style="width:100%">Continuer avec Google</button>
  </div>
</section>

<!-- APP SHELL -->
<section id="view-app" class="hidden">
<header>
  <div class="left">
    <button id="btn-menu" class="hamburger" aria-label="Ouvrir le menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
    <div class="tit">
      <div style="font-weight:900">Bon apr√®s-midi !</div>
      <div style="font-size:12px;color:#475569">
        R√¥le: <span id="role-badge" class="role-badge">‚Ä¶</span> ¬∑
        Connect√© : <span id="user-email">‚Ä¶</span>
      </div>
    </div>
  </div>
  <button id="btn-logout" class="btn btn-outline">Se d√©connecter</button>
</header>


<!-- Drawer (menu hamburger) -->
<div id="drawer" class="drawer">
  <div class="drawer-backdrop" id="drawer-backdrop"></div>
  <aside class="drawer-panel">
    <div class="drawer-top">
      <img src="logo-camping-la-plage.png" alt="La Plage">
      <div>
        <div>R√¥le : <span id="role-badge2" class="role-badge">‚Ä¶</span></div>
        <div class="email" id="user-email2">‚Ä¶</div>
      </div>
    </div>
    <nav id="menu-list" class="menu"></nav>
    <div class="drawer-bottom">
      <button id="drawer-logout" class="btn btn-outline" style="width:100%">Se d√©connecter</button>
    </div>
  </aside>
</div>


  <div class="container grid" id="route-container">
    <!-- content injected -->
  </div>
</section>

<template id="tpl-reception">
  <div class="grid">

    <!-- Barre type/priorit√© -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Type</label>
          <select id="rec-type">
            <option value="technique">Technique</option>
            <option value="location">Location</option>
          </select>
        </div>
        <div class="col" id="wrap-priority">
          <label>Priorit√©</label>
          <select id="rec-priority">
            <option value="normale">Normale</option>
            <option value="haute">Haute</option>
            <option value="urgente">Urgente</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Carte INTERVENTION -->
    <div id="card-interv" class="card">
      <div class="section-title">Nouvelle intervention</div>
      <p class="muted" style="margin-top:-6px">Assignation auto selon type</p>

      <label>Mobil Home</label>
      <input id="rec-mh" type="text" placeholder="Ex: B12"/>

      <label>D√©tail</label>
      <textarea id="rec-detail" placeholder="D√©crivez le probl√®me‚Ä¶"></textarea>

      <div class="row">
        <div class="col">
          <label>Clients pr√©sents ?</label>
          <div class="pill-switch" data-target="rec-clients">
            <button data-v="oui" class="on">Oui</button>
            <button data-v="non">Non</button>
          </div>
        </div>
        <div class="col">
          <label>Autorisation d'entr√©e ?</label>
          <div class="pill-switch" data-target="rec-autorise">
            <button data-v="oui" class="on">Oui</button>
            <button data-v="non">Non</button>
          </div>
        </div>
      </div>

      <div class="actions-right" style="margin-top:12px">
        <button id="rec-create" class="btn btn-primary" style="min-width:120px">Cr√©er</button>
      </div>
    </div>

<!-- Carte LOCATION -->
<div id="card-location" class="card hidden">
  <div class="section-title">Location</div>
  <p class="muted" style="margin-top:-6px">S√©lectionnez les objets √† louer (stock en direct) et indiquez le Mobil Home.</p>

  <label>Mobil Home</label>
  <input id="loc-mh" type="text" placeholder="Ex: B12"/>

  <div id="loc-grid" class="loc-grid" style="margin-top:8px"></div>

  <div class="row" style="margin-top:10px">
<span id="loc-total" class="muted">0 objet s√©lectionn√©</span>

    <div class="actions-right">
      <button id="loc-validate" class="btn btn-primary" style="min-width:160px">Cr√©er la demande</button>
    </div>
  </div>
</div>


    <!-- Kanban (interventions uniquement) -->
    <div class="grid">
      <div class="section-title">File Techniciens</div>

      <div class="toolrow">
        <input id="flt-search" type="text" placeholder="Rechercher (MH, email, d√©tail)">
        <select id="flt-status">
          <option value="">Tous statuts</option>
          <option value="a_faire">√Ä faire</option>
          <option value="en_cours">En cours</option>
          <option value="termine">Termin√©</option>
        </select>
        <select id="flt-priority">
          <option value="">Toutes priorit√©s</option>
          <option value="urgente">Urgente</option>
          <option value="haute">Haute</option>
          <option value="normale">Normale</option>
        </select>
        <button id="flt-clear" class="btn btn-outline">R√©initialiser</button>
      </div>

      <div class="kanban" id="rec-kanban"></div>
    </div>

  </div>
</template>


<template id="tpl-technique">
  <div class="grid">
    <div class="section-title">Interventions</div>

    <div class="toolrow">
      <input id="flt-search" type="text" placeholder="Rechercher (MH, email, d√©tail)">
      <select id="flt-status">
        <option value="">Tous statuts</option>
        <option value="a_faire">√Ä faire</option>
        <option value="en_cours">En cours</option>
        <option value="termine">Termin√©</option>
      </select>
      <select id="flt-priority">
        <option value="">Toutes priorit√©s</option>
        <option value="urgente">Urgente</option>
        <option value="haute">Haute</option>
        <option value="normale">Normale</option>
      </select>
      <button id="flt-clear" class="btn btn-outline">R√©initialiser</button>
    </div>

    <div class="kanban" id="tech-kanban"></div>
  </div>
</template>


<template id="tpl-menage">
  <div class="grid">
    <div class="section-title">T√¢ches M√©nage</div>
    <p class="muted">(en attente de r√©ception)</p>
  </div>
</template>
<template id="tpl-pending">
  <div class="center" style="min-height:60dvh">
    <div class="card login-card" style="max-width:480px">
      <div class="logo">
        <img src="logo-camping-la-plage.png" alt="La Plage" style="height:60px;object-fit:contain"/>
      </div>
      <h1>Compte en attente</h1>
      <p class="muted">
        Votre compte a bien √©t√© cr√©√© mais n'a pas encore de r√¥le.<br/>
        Merci de contacter un administrateur pour vous attribuer :<br/>
        <b>R√©ception</b>, <b>Technique</b> ou <b>M√©nage</b>.
      </p>
      <button id="btn-logout2" class="btn btn-outline" style="width:100%">Se d√©connecter</button>
    </div>
  </div>
</template>

<template id="tpl-admin">
  <div class="grid">
    <div class="section-title">Gestion des comptes salari√©</div>

    <!-- Barre d‚Äôattribution rapide par email (stock√©e dans 'directory') -->
    <div class="card">
      <div class="row">
        <input id="adm-email" type="text" placeholder="Email salari√©" />
        <select id="adm-role">
          <option value="reception">R√©ception</option>
          <option value="technique">Technique</option>
          <option value="menage">M√©nage</option>
          <option value="admin">Admin</option>
        </select>
        <button id="adm-add" class="btn btn-primary btn-sm">Attribuer le r√¥le</button>
      </div>
      <p class="muted" style="margin-top:8px">
        Astuce : si l‚Äôemploy√© ne s‚Äôest pas encore connect√©, utilisez cette barre.
      </p>
    </div>

    <!-- Liste des utilisateurs existants (cartes) -->
    <div id="adm-list" class="list"></div>
  </div>
</template>


<template id="tpl-inventory">
  <div class="grid">
    <div class="card">
      <div class="row">
        <input id="inv-name" class="col" type="text" placeholder="Nouvel objet">
        <input id="inv-qty" style="max-width:120px" type="number" value="1"/>
        <button id="inv-add" class="btn btn-primary">Ajouter</button>
      </div>
    </div>

    <!-- Liste en cartes -->
    <div id="inv-list" class="list"></div>
  </div>
</template>


<script type="module">
  /*************************************************
   *  Firebase SDK (client-only; works on GitHub Pages)
   *  1) Cr√©ez un projet Firebase
   *  2) Activez Authentication (Google) et Firestore
   *  3) Remplissez firebaseConfig ci‚Äëdessous
   *************************************************/
  // üëâ REMPLACEZ par votre config
const firebaseConfig = {
  apiKey: "AIzaSyD3UqR7G6LJxQOft046GVuvalq61Nmga80",
  authDomain: "dashboardv6-41aba.firebaseapp.com",
  projectId: "dashboardv6-41aba",
  storageBucket: "dashboardv6-41aba.appspot.com",
  messagingSenderId: "837982707095",
  appId: "1:837982707095:web:efd87ab0b9dca97f51b8d2"
};

  // Charger Firebase modules dynamiquement pour rester dans un seul fichier
const [{ initializeApp },
       { getAuth, onAuthStateChanged,
         GoogleAuthProvider,
         signInWithPopup, signInWithRedirect, getRedirectResult,
         setPersistence, browserLocalPersistence, inMemoryPersistence,
         signOut },
{ getFirestore, doc, getDoc, setDoc, collection, addDoc, updateDoc, deleteDoc,
  onSnapshot, query, where, orderBy, serverTimestamp, increment }
] = await Promise.all([
  import('https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js'),
  import('https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js'),
  import('https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js'),
]);


  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

// Persistance durable si possible (sinon m√©moire)
try { await setPersistence(auth, browserLocalPersistence); }
catch { await setPersistence(auth, inMemoryPersistence); }

// Si on revient d'un redirect, finalise la connexion (sinon no-op)
try { await getRedirectResult(auth); } catch(e){ console.warn('redirect result:', e?.message||e); }

  const db = getFirestore(app);

  // DOM helpers
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const show = id => { $('#view-login').classList.add('hidden'); $('#view-app').classList.remove('hidden'); };
  const hideApp = ()=>{ $('#view-app').classList.add('hidden'); $('#view-login').classList.remove('hidden'); };

  // State
  let currentUser = null;   // {uid, displayName, email}
  let currentRole = null;   // 'admin' | 'reception' | 'technique' | 'menage'
  const ROLES = ['admin','reception','technique','menage'];

  // --- Auth UI ---
$('#btn-google').addEventListener('click', async ()=>{
  const provider = new GoogleAuthProvider();
  try {
    // Toujours essayer POPUP en premier (marche aussi sur iOS r√©cent quand d√©clench√© par clic)
    await signInWithPopup(auth, provider);
  } catch(e){
    // Fallback si popup bloqu√© / non support√©
    const code = e?.code || '';
    if (code === 'auth/popup-blocked' ||
        code === 'auth/popup-closed-by-user' ||
        code === 'auth/operation-not-supported-in-this-environment') {
      try {
        await signInWithRedirect(auth, provider);
      } catch(e2){
        alert('Connexion impossible: ' + (e2?.message || e2));
      }
    } else {
      alert('Connexion impossible: ' + (e?.message || e));
    }
  }
});


  $('#btn-logout').addEventListener('click', ()=> signOut(auth));

onAuthStateChanged(auth, async (user) => {
  if (!user) { hideApp(); return; }

  currentUser = user;

  const uref = doc(db, 'users', user.uid);
  let snap;

  // 1) Essaye de lire le profil; si √ßa √©choue, cr√©e-le.
  try {
    snap = await getDoc(uref);
  } catch (e) {
    try {
      await setDoc(uref, {
        uid: user.uid,
        email: user.email,
        name: user.displayName || '',
        role: 'pending',
        createdAt: serverTimestamp(),
        active: true
      }, { merge:true });
      snap = await getDoc(uref);
    } catch (e2) {
      console.error('Profile read/create failed:', e2);
      alert("Probl√®me d'acc√®s au profil. V√©rifie les r√®gles Firestore.");
      hideApp();
      return;
    }
  }

  if (!snap.exists()) {
    await setDoc(uref, {
      uid: user.uid,
      email: user.email,
      name: user.displayName || '',
      role: 'pending',
      createdAt: serverTimestamp(),
      active: true
    });
    snap = await getDoc(uref);
  }

  // 2) Statut + r√¥le
  const d = snap.data();
  if (d.active === false) { alert('Compte d√©sactiv√©.'); await signOut(auth); return; }
  currentRole = d.role || 'pending';

  // 3) UI
  $('#user-email').textContent = currentUser.email || '';
  $('#role-badge').textContent = currentRole || '';
  show();
  buildTabs();
  navigateTo(defaultRoute());

  // 4) Synchro √©ventuelle depuis 'directory'
  try { await syncRoleFromDirectory(); } catch (_) {}
});



  // Routing based on role
const routesByRole = {
  admin:     ['reception','technique','menage','inventory-tech','inventory-menage','inventory-location','admin'],
  reception: ['reception','inventory-location'],
  technique: ['technique','inventory-tech'],
  menage:    ['menage','inventory-menage'],
  pending:   ['pending']
};

const labels = {
  'reception':'R√©ception',
  'technique':'Technique',
  'menage':'M√©nage',
  'admin':'Administration',
  'inventory-tech':'Inventaire (Technique)',
  'inventory-menage':'Inventaire (M√©nage)',
  'inventory-location':'Inventaire (Location)',
  'pending':"En attente d'attribution"
};


  const defaultRoute = ()=> routesByRole[currentRole]?.[0] || 'reception';

function buildTabs(){
  const items = routesByRole[currentRole] || [];
  const menu = $('#menu-list');
  menu.innerHTML = '';
  for(const r of items){
    const b = document.createElement('button');
    b.className = 'menu-item';
    b.dataset.route = r;
    b.textContent = labels[r] || r;
    b.addEventListener('click', ()=>{ navigateTo(r); closeDrawer(); });
    menu.appendChild(b);
  }
  // infos dans le drawer
const ue = $('#user-email2'); if (ue) ue.textContent = currentUser?.email || '';
const rb = $('#role-badge2'); if (rb) rb.textContent = currentRole || '';

}

function setActiveTab(route){
  $$('#menu-list .menu-item').forEach(b=> b.classList.toggle('active', b.dataset.route===route));
}

function openDrawer(){ $('#drawer').classList.add('open'); $('#btn-menu')?.setAttribute('aria-expanded','true'); }
function closeDrawer(){ $('#drawer').classList.remove('open'); $('#btn-menu')?.setAttribute('aria-expanded','false'); }

// Ouverture / fermeture
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'btn-menu') openDrawer();
  if(e.target && e.target.id === 'drawer-backdrop') closeDrawer();
});
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

// Logout depuis le drawer
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'drawer-logout') signOut(auth);
});

  window.addEventListener('hashchange', ()=> navigateTo(location.hash.replace('#','')));

async function navigateTo(route){
  if(!route){ route = defaultRoute(); }
  setActiveTab(route);
  const host = $('#route-container');
  host.innerHTML='';

  if(route==='reception')            renderReception(host);
  else if(route==='technique')       renderTechnique(host);
  else if(route==='menage')          renderMenage(host);
  else if(route==='admin')           renderAdmin(host);
  else if(route==='inventory-tech')  renderInventory(host, 'inventory_tech');
  else if(route==='inventory-menage')renderInventory(host, 'inventory_menage');
  else if(route==='pending')         renderPending(host);    // ‚úÖ manquait
  else if(route==='inventory-location') renderInventory(host, 'inventory_location');


  location.hash = '#'+route;
}


// --- Polyfill CSS.escape (Safaris/anciens) ---
if (!window.CSS) window.CSS = {};
if (typeof window.CSS.escape !== 'function') {
  window.CSS.escape = function (sel) {
    return String(sel).replace(/[^a-zA-Z0-9_\-]/g, s => '\\' + s);
  };
}

  /*************** RECEPTION (create interventions) ***************/
function renderReception(host){
  host.appendChild(document.importNode($('#tpl-reception').content,true));

  // switches (intervention)
  $$('.pill-switch', host).forEach(sw=>{
    sw.addEventListener('click', (e)=>{
      if(e.target.tagName!=='BUTTON') return;
      $$('.pill-switch button', sw).forEach(b=>b.classList.remove('on'));
      e.target.classList.add('on');
      sw.dataset.value = e.target.dataset.v;
    });
    sw.dataset.value = 'oui';
  });

  const typeSel    = $('#rec-type', host);
  const wrapPrio   = $('#wrap-priority', host);
  const cardInterv = $('#card-interv', host);
  const cardLoc    = $('#card-location', host);
  const grid       = $('#loc-grid', host);
  const locMH      = $('#loc-mh', host);

  // items + s√©lection
  const RENT_ITEMS = [
    {name:'Plancha (Petite)', icon:'üç≥'},
    {name:'Plancha (Grande)', icon:'ü•ò'},
    {name:'Lit b√©b√©',         icon:'üõèÔ∏è'},
    {name:'Chaise b√©b√©',      icon:'üçº'},
    {name:'TV',               icon:'üì∫'},
    {name:'Ventilateur',      icon:'üåÄ'},
  ];
  const sel = Object.fromEntries(RENT_ITEMS.map(i=>[i.name,0]));
  let avail = {};

  function toggleCards(){
    const isLoc = typeSel.value === 'location';
    cardLoc.classList.toggle('hidden', !isLoc);
    cardInterv.classList.toggle('hidden', isLoc);
    wrapPrio.classList.toggle('hidden', isLoc); // pas de priorit√© pour une location
  }
  typeSel.addEventListener('change', toggleCards);
  toggleCards();

  // --- TOTAL null-safe
  function updateTotal(){
    const n = Object.values(sel).reduce((s,x)=>s+x,0);
    const lbl = $('#loc-total', host);
    if (lbl) lbl.textContent = n===1 ? '1 objet s√©lectionn√©' : `${n} objets s√©lectionn√©s`;
  }

  // --- Rendu de la grille
function renderGrid(){
  grid.innerHTML = '';
  RENT_ITEMS.forEach(it=>{
    const stock = avail[it.name] ?? 0;
    const q = sel[it.name] || 0;
    const el = document.createElement('div');
    el.className = 'loc-item';
    el.innerHTML = `
      <div class="loc-head">
        <div class="loc-name">${it.icon} ${escapeHtml(it.name)}</div>
        <!-- ‚ö†Ô∏è ne PAS √©chapper la valeur stock√©e dans l'attribut -->
        <span class="loc-stock" data-stock="${it.name}">${stock} dispo</span>
      </div>
      <div class="stepper">
        <button class="btn btn-outline btn-sm" data-a="minus" data-name="${it.name}">‚Äì1</button>
        <!-- ‚ö†Ô∏è idem ici : on stocke la valeur brute -->
        <span class="qty" data-qty="${it.name}">${q}</span>
        <button class="btn btn-outline btn-sm" data-a="plus"  data-name="${it.name}">+1</button>
      </div>
    `;
    grid.appendChild(el);
  });
  updateTotal();
}


  onSnapshot(collection(db,'inventory_location'), (snap)=>{
    avail = {};
    snap.forEach(d=>{ const x=d.data(); avail[x.name]=x.qty||0; });
    renderGrid();
  });

  // --- Click sur +/‚Äì (null-safe)
  grid.addEventListener('click',(e)=>{
    const a = e.target?.dataset?.a; if(!a) return;
    const name = e.target.dataset.name;
    const max = (avail[name] ?? Infinity);
    if(a==='plus')  sel[name] = Math.min(max, (sel[name]||0)+1);
    if(a==='minus') sel[name] = Math.max(0, (sel[name]||0)-1);

    const qtyEl = $(`.qty[data-qty="${CSS.escape(name)}"]`, host);
    if (qtyEl) qtyEl.textContent = String(sel[name]);   // ‚úÖ √©vite le crash
    updateTotal();
  });

  // ---- Cr√©ation intervention (classique)
  $('#rec-create', host).addEventListener('click', async ()=>{
    const payload = {
      type: 'technique',
      priority: $('#rec-priority', host).value,
      mobilhome: $('#rec-mh', host).value.trim(),
      details: $('#rec-detail', host).value.trim(),
      clientsPresent: $('[data-target="rec-clients"]', host).dataset.value==='oui',
      autorise: $('[data-target="rec-autorise"]', host).dataset.value==='oui',
      status: 'a_faire',
      createdBy: currentUser.uid,
      createdByEmail: currentUser.email,
      createdAt: serverTimestamp(),
      doneBy: null,
    };
    if(!payload.mobilhome){ alert('N¬∞ Mobilhome requis.'); return; }
    try{
      await addDoc(collection(db,'interventions'), payload);
      $('#rec-mh', host).value=''; $('#rec-detail', host).value='';
    }catch(e){ alert('Erreur: '+e.message); }
  });

  // ---- Cr√©ation d'une LOCATION -> intervention "√† faire" + d√©cr√©ment stock
  $('#loc-validate', host).addEventListener('click', async ()=>{
    const items = Object.entries(sel).filter(([,q])=>q>0).map(([name,qty])=>({name,qty}));
    const mh = (locMH.value||'').trim();
    if(!mh){ alert('Indiquez le Mobil Home.'); return; }
    if(items.length===0){ alert('S√©lectionnez au moins un objet.'); return; }

    try{
      await addDoc(collection(db,'interventions'), {
        type:'location',
        mobilhome: mh,
        items,
        priority: 'normale',
        status:'a_faire',
        createdBy: currentUser.uid,
        createdByEmail: currentUser.email,
        createdAt: serverTimestamp()
      });

      // d√©cr√©mente le stock (r√©servation)
      for(const it of items){
        await setDoc(doc(db,'inventory_location', slug(it.name)),
          { name: it.name, qty: increment(-it.qty) },
          { merge:true }
        );
      }

      // reset
      Object.keys(sel).forEach(k=> sel[k]=0);
      $$('.qty', host).forEach(e=> e.textContent='0');
      locMH.value='';
      updateTotal();
      alert('Demande de location cr√©√©e ‚úÖ');
    }catch(e){ alert('Erreur: '+e.message); }
  });

  // Kanban
  const kanban = $('#rec-kanban', host);
  mountInterventionsKanban(kanban, true, host);
}




  /*************** TECHNIQUE (kanban + validate) ***************/
  function renderTechnique(host){
    host.appendChild(document.importNode($('#tpl-technique').content,true));
    const kanban = $('#tech-kanban', host);
mountInterventionsKanban(kanban, true, host);

  }

  /*************** MENAGE (placeholder) ***************/
  function renderMenage(host){
    host.appendChild(document.importNode($('#tpl-menage').content,true));
  }
function renderPending(host){
  host.appendChild(document.importNode($('#tpl-pending').content,true));
  $('#btn-logout2', host).addEventListener('click', ()=> signOut(auth));
}

  // Shared kanban renderer for interventions
function mountInterventionsKanban(container, allowActions, controlsRoot){
  const cols = [
    {key:'a_faire', title:'√Ä faire'},
    {key:'en_cours', title:'En cours'},
    {key:'termine', title:'Termin√©'},
  ];
  container.innerHTML = cols
    .map(c=>`<div class="kanban-col" data-col="${c.key}">
               <h3>${c.title} <span class="col-count">0</span></h3>
               <div class="col-body"></div>
             </div>`).join('');

  const el = id => controlsRoot ? controlsRoot.querySelector('#'+id) : null;
  const parseFilter = () => ({
    q: (el('flt-search')?.value || '').trim().toLowerCase(),
    status: el('flt-status')?.value || '',
    prio: (el('flt-priority')?.value || '')
  });
  const attach = (id, type='input') => { const x=el(id); if(x){ x.addEventListener(type, apply); } };
  attach('flt-search','input'); attach('flt-status','change'); attach('flt-priority','change');
  const clearBtn = el('flt-clear'); if(clearBtn){ clearBtn.addEventListener('click', ()=>{ if(el('flt-search')) el('flt-search').value=''; if(el('flt-status')) el('flt-status').value=''; if(el('flt-priority')) el('flt-priority').value=''; apply(); }); }

  let docs = [];
  const qRef = query(collection(db,'interventions'), orderBy('createdAt','desc'));
  const unsub = onSnapshot(qRef, (snap)=>{
    docs = []; snap.forEach(ds=> docs.push({ id: ds.id, data: ds.data() }));
    apply();
  });

  function apply(){
    const filter = parseFilter();
    const bodies = {};
    $$('.kanban-col', container).forEach(col=>{
      $('.col-body', col).innerHTML = '';
      $('.col-count', col).textContent = '0';
      bodies[col.dataset.col] = $('.col-body', col);
    });
    const counts = { a_faire:0, en_cours:0, termine:0 };

    docs.forEach(item=>{
      const d = item.data;
      const isLoc = (d.type||'').toLowerCase()==='location';

      // filtres
      if(filter.prio && (d.priority||'').toLowerCase() !== filter.prio) return;
      if(filter.status && (d.status||'a_faire') !== filter.status) return;
      if(filter.q){
        const itemsTxt = (d.items||[]).map(x=>`${x.name} ${x.qty}`).join(' ');
        const hay = [d.mobilhome||'', d.details||'', d.createdByEmail||'', (d.priority||''), itemsTxt].join(' ').toLowerCase();
        if(!hay.includes(filter.q)) return;
      }

      const pr = (d.priority||'normale').toLowerCase();
      const prClass = pr==='urgente' ? 'urgent' : (pr==='haute' ? 'high' : 'normal');

      const card = document.createElement('div'); card.className='ticket';
      card.innerHTML = `
        <div class="t-top">
          <div class="t-title">${isLoc?'LOC ‚Ä¢ ':''}MH <b>${escapeHtml(d.mobilhome||'?')}</b></div>
          ${isLoc
            ? `<span class="chip pr normal">LOCATION</span>`
            : `<span class="chip pr ${prClass}">${(d.priority||'normale').toUpperCase()}</span>`
          }
        </div>
        ${ isLoc
            ? `<div class="t-details">${
                (d.items||[]).map(it=>`<span class="chip">${escapeHtml(it.name)} √ó ${it.qty}</span>`).join(' ')
              }</div>`
            : (d.details?`<div class="t-details">${escapeHtml(d.details)}</div>`:'')
        }
        ${ !isLoc ? `
        <div class="t-chips">
          <span class="chip ${d.clientsPresent?'green':'red'}">Clients ${d.clientsPresent?'pr√©sents':'absents'}</span>
          <span class="chip ${d.autorise?'green':'red'}">${d.autorise?'Autoris√©':'Interdit'}</span>
        </div>` : '' }
        <div class="meta">${escapeHtml(d.createdByEmail||'')}</div>
        ${allowActions && (currentRole==='technique' || currentRole==='admin') ? `
          <div class="ticket-actions">
            <button class="btn btn-outline btn-sm" data-act="to_en_cours">En cours</button>
            <button class="btn btn-success btn-sm" data-act="to_termine">Terminer</button>
          </div>` : '' }
      `;

      card.addEventListener('click', async (e)=>{
        const act = e.target?.dataset?.act; if(!act) return;
        const ref = doc(db,'interventions', item.id);
        try{
          if(act==='to_en_cours') await updateDoc(ref, { status:'en_cours' });
          if(act==='to_termine') await updateDoc(ref, { status:'termine', doneBy: currentUser.email, doneAt:serverTimestamp() });
        }catch(err){ alert(err.message); }
      });

      const key = (d.status||'a_faire');
      const mount = bodies[key] || bodies['a_faire'];
      mount.appendChild(card);
      counts[key] += 1;
    });

    Object.entries(counts).forEach(([k,v])=>{
      const badge = $(`.kanban-col[data-col="${k}"] .col-count`, container);
      if(badge) badge.textContent = String(v);
    });
  }

  container._unsub = unsub;
}


function storageAvailable(type){
  try { const x='__t'; window[type].setItem(x,x); window[type].removeItem(x); return true; }
  catch(e){ return false; }
}
const isIOS = /iP(ad|hone|od)/.test(navigator.platform) || /iPhone|iPad|iPod/.test(navigator.userAgent);


  /********************* ADMIN ************************/ 
function renderAdmin(host){
  host.appendChild(document.importNode($('#tpl-admin').content,true));

  // Attribution anticip√©e via 'directory'
  $('#adm-add', host).addEventListener('click', async ()=>{
    const email = $('#adm-email', host).value.trim().toLowerCase();
    const role = $('#adm-role', host).value;
    if(!email) return alert('Email requis');
    try{
      const key = email.replaceAll('.', '¬∑');
      await setDoc(doc(db,'directory', key), { email, role, updatedAt:serverTimestamp() }, { merge:true });
      alert('R√¥le enregistr√©. Au prochain login, l‚Äôutilisateur h√©ritera de ce r√¥le.');
      $('#adm-email', host).value = '';
    }catch(e){ alert(e.message); }
  });

  // Liste en cartes des comptes existants (collection 'users')
  const list = $('#adm-list', host);
  const unsub = onSnapshot(collection(db,'users'), (snap)=>{
    list.innerHTML = '';
    snap.forEach(s=>{
      const u = s.data();
      const card = document.createElement('div');
      card.className = 'user-card';
card.innerHTML = `
  <div class="uc-top">
    <div class="uc-name">${escapeHtml(u.name||'(Sans nom)')}</div>
    <span class="chip role">${escapeHtml(u.role||'pending')}</span>
  </div>
  <div class="uc-email">${escapeHtml(u.email||'')}</div>
  <div class="uc-actions">
    <button class="btn btn-outline btn-sm" data-a="setrole" data-id="${s.id}">Changer r√¥le</button>
    <button class="btn btn-danger btn-sm" data-a="deactivate" data-id="${s.id}">
      ${u.active===false?'R√©activer':'D√©sactiver'}
    </button>
  </div>
`;
      list.appendChild(card);
    });
  });

  // Actions sur les cartes
  $('#adm-list', host).addEventListener('click', async (e)=>{
    const id = e.target?.dataset?.id; if(!id) return;
    const action = e.target.dataset.a;
    const ref = doc(db,'users', id);

    if(action === 'deactivate'){
      const snap = await getDoc(ref);
      const curr = snap.data();
      await updateDoc(ref, { active: !(curr?.active !== false) }); // toggle
      return;
    }

    if(action === 'setrole'){
      const role = prompt('Nouveau r√¥le (admin/reception/technique/menage):', 'reception');
      if(!role || !['admin','reception','technique','menage'].includes(role)) return alert('R√¥le invalide');
      await updateDoc(ref, { role });
      alert('R√¥le mis √† jour.');
      return;
    }
  });
}

  /******************* INVENTORY (tech or menage) ******************/
function renderInventory(host, collectionName){
  host.appendChild(document.importNode($('#tpl-inventory').content,true));
  const list = $('#inv-list', host);

  $('#inv-add', host).addEventListener('click', async ()=>{
    const name = $('#inv-name', host).value.trim();
    const qty = parseInt($('#inv-qty', host).value||'0',10);
    if(!name) return alert('Objet requis');
    await addDoc(collection(db, collectionName), { name, qty, createdAt:serverTimestamp() });
    $('#inv-name', host).value='';
  });

  const unsub = onSnapshot(query(collection(db,collectionName), orderBy('name')), (snap)=>{
    list.innerHTML='';
    snap.forEach(s=>{
      const d=s.data();
      const card=document.createElement('div');
      card.className='inv-card';
      card.innerHTML=`
        <div class="inv-top">
          <div class="inv-name">${escapeHtml(d.name)}</div>
          <span class="qty">${d.qty}</span>
        </div>
        <div class="inv-actions">
          <button class="btn btn-outline" data-a="minus" data-id="${s.id}">‚Äì1</button>
          <button class="btn btn-outline" data-a="plus" data-id="${s.id}">+1</button>
          <button class="btn btn-danger" data-a="del" data-id="${s.id}">Supprimer</button>
        </div>
      `;
      list.appendChild(card);
    });
  });

  // actions
  list.addEventListener('click', async (e)=>{
    const id=e.target?.dataset?.id; if(!id) return;
    const ref = doc(db,collectionName,id);
    const a = e.target.dataset.a;

    if(a==='del'){ if(confirm('Supprimer ?')) await deleteDoc(ref); return; }

    const curr = (await getDoc(ref)).data(); // simple R/W; peut √™tre remplac√© par FieldValue.increment
    let qty = curr?.qty||0;
    if(a==='plus') qty++;
    if(a==='minus') qty=Math.max(0,qty-1);
    await updateDoc(ref,{ qty });
  });
}

function slug(s=''){ return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }

  /****************** UTIL ************************/ 
  function escapeHtml(x=''){ return x.replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }

  /****************** ROLE SYNC ********************/
  // Optionnel : quand l'utilisateur se connecte, on synchronise son r√¥le √† partir
  // de la collection 'directory' g√©r√©e par l'admin (cl√© = email).
async function syncRoleFromDirectory(){
  try {
    if (!currentUser) return;
    const key = (currentUser.email || '').toLowerCase().replaceAll('.', '¬∑');
    const entry = await getDoc(doc(db, 'directory', key));
    if (entry.exists()) {
      const role = entry.data().role;
      if (role && role !== currentRole) {
        await updateDoc(doc(db, 'users', currentUser.uid), { role });
        currentRole = role;
        $('#role-badge').textContent = currentRole;
        buildTabs();
        navigateTo(defaultRoute());
      }
    }
  } catch (e) {
    console.warn('Directory read denied:', e.message);
  }
}

  // run at start of each session
  setTimeout(syncRoleFromDirectory, 1000);

</script>
</body>
</html>
